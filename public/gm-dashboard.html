<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£ÙØ±ÙŠØ¬Ù„ÙˆØ¨Ø§Ù„ - Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Arial, sans-serif; background: #f4f6f9; direction: rtl; color: #333; }
        header {
            background: #1e3a5f; color: white; padding: 14px 24px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        header h1 { font-size: 20px; }
        .header-right { display: flex; align-items: center; gap: 16px; font-size: 14px; }
        .header-right a { color: white; text-decoration: none; }
        .header-right a:hover { text-decoration: underline; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 14px; }
        .btn-logout { background: #c0392b; color: white; }
        .btn-refresh { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); }
        .btn-refresh:hover { background: rgba(255,255,255,0.3); }
        .container { max-width: 1200px; margin: 24px auto; padding: 0 24px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .kpi-card {
            background: white; border-radius: 12px; padding: 20px 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07); border-right: 4px solid #1e3a5f;
        }
        .kpi-card.warning { border-right-color: #f39c12; }
        .kpi-card.danger { border-right-color: #e74c3c; }
        .kpi-card.success { border-right-color: #27ae60; }
        .kpi-label { font-size: 13px; color: #666; margin-bottom: 8px; }
        .kpi-value { font-size: 32px; font-weight: bold; color: #1e3a5f; }
        .kpi-card.warning .kpi-value { color: #f39c12; }
        .kpi-card.danger .kpi-value { color: #e74c3c; }
        .kpi-card.success .kpi-value { color: #27ae60; }
        .kpi-sub { font-size: 12px; color: #888; margin-top: 4px; }
        .card { background: white; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); margin-bottom: 24px; }
        .section-title { font-size: 18px; font-weight: bold; color: #1e3a5f; margin-bottom: 16px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #1e3a5f; color: white; padding: 12px 10px; text-align: right; }
        td { padding: 11px 10px; border-bottom: 1px solid #eee; }
        tr:hover td { background: #f8f9fa; }
        .elapsed-ok { color: #27ae60; font-weight: 600; }
        .elapsed-warn { color: #f39c12; font-weight: 600; }
        .elapsed-danger { color: #e74c3c; font-weight: bold; }
        .no-data { text-align: center; color: #888; padding: 30px; }
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
        .status-item { background: #f8f9fa; border-radius: 8px; padding: 14px; text-align: center; }
        .status-item .count { font-size: 28px; font-weight: bold; color: #1e3a5f; }
        .status-item .label { font-size: 12px; color: #666; margin-top: 4px; }
        @media (max-width: 768px) { .two-col { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header>
        <h1>ğŸŒ Ø£ÙØ±ÙŠØ¬Ù„ÙˆØ¨Ø§Ù„ - Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</h1>
        <div class="header-right">
            <span id="userInfo"></span>
            <a href="/sales">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</a>
            <a href="/procurement">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</a>
            <a href="/approvals">Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª</a>
            <button class="btn btn-refresh" onclick="loadKPIs()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn btn-logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <div class="container">
        <div class="kpi-grid" id="kpiGrid">
            <div class="kpi-card"><div class="kpi-label">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
        </div>

        <div class="two-col">
            <div class="card">
                <div class="section-title">âš ï¸ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚ÙØ© (Ù„Ù… ÙŠØ±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª)</div>
                <div id="stuckTable"><div class="no-data">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
            </div>
            <div class="card">
                <div class="section-title">â³ Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</div>
                <div id="pendingQuotesTable"><div class="no-data">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">ğŸ“Š Ù…Ù„Ø®Øµ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
            <div id="statusSummary"><div class="no-data">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
        </div>
    </div>

    <script>
        const API = '/api';
        let token = localStorage.getItem('token');
        let user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token) window.location.href = '/login';

        const allowed = ['gm', 'sales_manager', 'procurement_manager'];
        if (!allowed.includes(user.role)) window.location.href = '/sales';

        document.getElementById('userInfo').textContent = `${user.fullName || ''} (${roleLabel(user.role)})`;

        function roleLabel(r) {
            const m = {gm:'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…',sales_manager:'Ù…Ø¯ÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª',sales:'Ù…Ø¨ÙŠØ¹Ø§Øª',procurement_manager:'Ù…Ø¯ÙŠØ± Ù…Ø´ØªØ±ÙŠØ§Øª',procurement:'Ù…Ø´ØªØ±ÙŠØ§Øª'};
            return m[r] || r;
        }

        function logout() { localStorage.clear(); window.location.href = '/login'; }
        function authHeaders() { return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }; }

        function elapsedClass(h) {
            if (h < 24) return 'elapsed-ok';
            if (h < 48) return 'elapsed-warn';
            return 'elapsed-danger';
        }

        async function loadKPIs() {
            try {
                const res = await fetch(`${API}/dashboard/kpi`, { headers: authHeaders() });
                const data = await res.json();
                if (!data.success) return;
                const d = data.data;

                document.getElementById('kpiGrid').innerHTML = `
                    <div class="kpi-card success">
                        <div class="kpi-label">Ù…ØªÙˆØ³Ø· Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</div>
                        <div class="kpi-value">${d.supplierQuote.avgResponseHours}</div>
                        <div class="kpi-sub">Ø³Ø§Ø¹Ø© (ÙˆØ³ÙŠØ·: ${d.supplierQuote.medianResponseHours} Ø³Ø§Ø¹Ø©) â€¢ ${d.supplierQuote.totalResponded} Ø¹Ø±Ø¶</div>
                    </div>
                    <div class="kpi-card ${d.salesProcurementStage.avgResponseHours > 48 ? 'danger' : d.salesProcurementStage.avgResponseHours > 24 ? 'warning' : 'success'}">
                        <div class="kpi-label">Ù…ØªÙˆØ³Ø· Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                        <div class="kpi-value">${d.salesProcurementStage.avgResponseHours}</div>
                        <div class="kpi-sub">Ø³Ø§Ø¹Ø© â€¢ ${d.salesProcurementStage.totalCompleted} Ø·Ù„Ø¨ Ù…ÙƒØªÙ…Ù„</div>
                    </div>
                    <div class="kpi-card ${d.stuckOrders.length > 0 ? 'danger' : 'success'}">
                        <div class="kpi-label">Ø·Ù„Ø¨Ø§Øª Ù…ØªÙˆÙ‚ÙØ© (Ø£ÙƒØ«Ø± Ù…Ù† ${d.stuckThresholdHours} Ø³Ø§Ø¹Ø©)</div>
                        <div class="kpi-value">${d.stuckOrders.length}</div>
                        <div class="kpi-sub">Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† Ø±Ø¯ Ù…Ù† Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
                    </div>
                    <div class="kpi-card ${d.pendingQuotes.length > 5 ? 'warning' : 'success'}">
                        <div class="kpi-label">Ø¹Ø±ÙˆØ¶ Ø£Ø³Ø¹Ø§Ø± Ù…Ø¹Ù„Ù‚Ø©</div>
                        <div class="kpi-value">${d.pendingQuotes.length}</div>
                        <div class="kpi-sub">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ù…ÙˆØ±Ø¯</div>
                    </div>`;

                // Stuck orders
                if (!d.stuckOrders.length) {
                    document.getElementById('stuckTable').innerHTML = '<div class="no-data">âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ØªÙˆÙ‚ÙØ©</div>';
                } else {
                    let html = `<table><thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th><th>Ù…Ù†Ø° (Ø³Ø§Ø¹Ø©)</th></tr></thead><tbody>`;
                    for (const o of d.stuckOrders) {
                        const cls = elapsedClass(o.elapsedHours);
                        html += `<tr><td><b>${o.orderNumber}</b></td><td>${o.deliveryCity||'-'}</td><td class="${cls}">${o.elapsedHours} Ø³Ø§Ø¹Ø©</td></tr>`;
                    }
                    html += '</tbody></table>';
                    document.getElementById('stuckTable').innerHTML = html;
                }

                // Pending quotes
                if (!d.pendingQuotes.length) {
                    document.getElementById('pendingQuotesTable').innerHTML = '<div class="no-data">âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ù…Ø¹Ù„Ù‚Ø©</div>';
                } else {
                    let html = `<table><thead><tr><th>Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ù…Ù†Ø° (Ø³Ø§Ø¹Ø©)</th></tr></thead><tbody>`;
                    for (const q of d.pendingQuotes) {
                        const cls = elapsedClass(q.elapsedHours);
                        const so = q.salesOrder ? q.salesOrder.orderNumber : '-';
                        const sup = q.supplier ? q.supplier.nameAr : '-';
                        html += `<tr><td>${so}</td><td>${sup}</td><td>${q.productNameAr||'-'}</td><td class="${cls}">${q.elapsedHours} Ø³Ø§Ø¹Ø©</td></tr>`;
                    }
                    html += '</tbody></table>';
                    document.getElementById('pendingQuotesTable').innerHTML = html;
                }

                // Status summary
                const statusLabels = {
                    draft: 'Ù…Ø³ÙˆØ¯Ø©', submitted_to_procurement: 'Ø£Ø±Ø³Ù„ Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
                    procurement_responded: 'Ø±Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', confirmed: 'Ù…Ø¤ÙƒØ¯', cancelled: 'Ù…Ù„ØºÙŠ'
                };
                if (!d.orderStatusCounts.length) {
                    document.getElementById('statusSummary').innerHTML = '<div class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>';
                } else {
                    let html = '<div class="status-grid">';
                    for (const s of d.orderStatusCounts) {
                        html += `<div class="status-item"><div class="count">${s.count}</div><div class="label">${statusLabels[s._id] || s._id}</div></div>`;
                    }
                    html += '</div>';
                    document.getElementById('statusSummary').innerHTML = html;
                }
            } catch(err) {
                document.getElementById('kpiGrid').innerHTML = '<div class="kpi-card danger"><div class="kpi-label">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div></div>';
            }
        }

        loadKPIs();
        // Auto-refresh every 5 minutes
        setInterval(loadKPIs, 5 * 60 * 1000);
    </script>
</body>
</html>
