<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª â€“ Ø£ÙØ±ÙŠ Ø¬Ù„ÙˆØ¨Ø§Ù„</title>
<link rel="stylesheet" href="/new-styles.css">
</head>
<body>
<nav class="navbar" id="navbar"></nav>
<div class="container">
    <div class="card">
        <div class="card-title">ğŸ“¦ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>

        <div class="filter-bar">
            <div class="form-group">
                <label>Ø§Ù„ÙØªØ±Ø©</label>
                <select id="periodFilter"></select>
            </div>
            <button class="btn btn-primary" onclick="openAddModal()">+ Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø±</button>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Ù…</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                        <th>Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„</th><th>Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†</th><th>Ø§Ù„ÙˆØ§ØªØ³</th><th>Ø§Ù„Ù…Ù†Ø´Ø£</th>
                        <th>Ø§Ù„ØªØ±ÙƒÙŠØ²</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ù…Ø®Ø²Ù†</th><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        <th>ÙˆÙ‚Øª Ø§Ù„Ø³Ø¤Ø§Ù„</th><th>ÙˆÙ‚Øª Ø§Ù„Ø±Ø¯</th><th>Ù…Ø¯Ø© Ø§Ù„Ø±Ø¯ (Ø¯)</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                    </tr>
                </thead>
                <tbody id="reportBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal">
    <div class="modal-box">
        <div class="modal-header">
            <h3>Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± â€“ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h3>
            <button class="modal-close" onclick="closeModal()">âœ•</button>
        </div>
        <form id="rowForm">
            <input type="hidden" id="editId">
            <div class="form-group"><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="fDate" required></div>
            <div class="form-group"><label>Ø§Ù„Ù…Ø§Ø¯Ø©</label><input type="text" id="fMaterial" required></div>
            <div class="form-group"><label>Ø§Ù„Ù…ÙˆØ±Ø¯</label><input type="text" id="fSupplier"></div>
            <div class="form-group"><label>Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„</label><input type="text" id="fResponsible"></div>
            <div class="form-group"><label>Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†</label><input type="tel" id="fPhone"></div>
            <div class="form-group"><label>Ø§Ù„ÙˆØ§ØªØ³</label><input type="tel" id="fWhatsapp"></div>
            <div class="form-group"><label>Ø§Ù„Ù…Ù†Ø´Ø£</label><input type="text" id="fOrigin"></div>
            <div class="form-group"><label>Ø§Ù„ØªØ±ÙƒÙŠØ²</label><input type="text" id="fConcentration"></div>
            <div class="form-group"><label>Ø§Ù„Ø³Ø¹Ø±</label><input type="number" step="any" id="fPrice"></div>
            <div class="form-group"><label>Ø§Ù„Ù…Ø®Ø²Ù†</label><input type="text" id="fWarehouse"></div>
            <div class="form-group"><label>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="fNotes"></textarea></div>
            <div class="form-group"><label>ÙˆÙ‚Øª Ø§Ù„Ø³Ø¤Ø§Ù„</label><input type="time" id="fAskTime"></div>
            <div class="form-group"><label>ÙˆÙ‚Øª Ø§Ù„Ø±Ø¯</label><input type="time" id="fReplyTime"></div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </form>
    </div>
</div>

<script src="/new-app.js"></script>
<script>
    const user = requireAuth();
    renderNavbar(user);

    const STORE_KEY = 'proc_report';
    const canEdit = Roles.isAdmin(user.role) || Roles.isProcurement(user.role) || Roles.isGM(user.role);
    let todayDate = '';

    fetchTodayDate().then(d => {
        todayDate = d;
        document.getElementById('fDate').value = d;
    });

    function minutesDiff(t1, t2) {
        if (!t1 || !t2) return '';
        const parts1 = t1.split(':');
        const parts2 = t2.split(':');
        if (parts1.length < 2 || parts2.length < 2) return '';
        const [h1, m1] = parts1.map(Number);
        const [h2, m2] = parts2.map(Number);
        if (isNaN(h1) || isNaN(m1) || isNaN(h2) || isNaN(m2)) return '';
        const diff = (h2 * 60 + m2) - (h1 * 60 + m1);
        return diff >= 0 ? diff : '';
    }

    function buildPeriods() {
        const rows = getStore(STORE_KEY);
        const periods = [...new Set(rows.map(r => r.date ? r.date.slice(0,7) : ''))].filter(Boolean).sort().reverse();
        const cur = currentPeriod();
        if (!periods.includes(cur)) periods.unshift(cur);
        const sel = document.getElementById('periodFilter');
        sel.innerHTML = periods.map(p => `<option value="${p}">${periodLabel(p)}</option>`).join('');
        if (Roles.isManager(user.role)) sel.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ÙØªØ±Ø§Øª</option>' + sel.innerHTML;
        else sel.value = cur;
    }

    function render() {
        const period = document.getElementById('periodFilter').value;
        let rows = getStore(STORE_KEY);
        if (period) rows = rows.filter(r => r.date && r.date.startsWith(period));
        const tbody = document.getElementById('reportBody');
        if (rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="16" class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
            return;
        }
        tbody.innerHTML = rows.map((r, i) => `
            <tr>
                <td>${i+1}</td><td>${r.date||''}</td><td>${r.material||''}</td><td>${r.supplier||''}</td>
                <td>${r.responsible||''}</td><td>${r.phone||''}</td><td>${r.whatsapp||''}</td>
                <td>${r.origin||''}</td><td>${r.concentration||''}</td><td>${r.price||''}</td>
                <td>${r.warehouse||''}</td><td>${r.notes||''}</td>
                <td>${r.askTime||''}</td><td>${r.replyTime||''}</td>
                <td>${minutesDiff(r.askTime, r.replyTime)}</td>
                <td>${canEdit ? `<button class="btn btn-danger btn-sm" onclick="deleteRow('${r.id}')">Ø­Ø°Ù</button>` : ''}</td>
            </tr>`).join('');
    }

    document.getElementById('periodFilter').addEventListener('change', render);

    function openAddModal() {
        if (!canEdit) return alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        document.getElementById('editId').value = '';
        document.getElementById('rowForm').reset();
        document.getElementById('fDate').value = todayDate;
        document.getElementById('modal').classList.add('active');
    }
    function closeModal() { document.getElementById('modal').classList.remove('active'); }

    function deleteRow(id) {
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±ØŸ')) return;
        setStore(STORE_KEY, getStore(STORE_KEY).filter(r => r.id !== id));
        buildPeriods(); render();
    }

    document.getElementById('rowForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const rows = getStore(STORE_KEY);
        rows.push({
            id: uid(),
            date: document.getElementById('fDate').value,
            material: document.getElementById('fMaterial').value,
            supplier: document.getElementById('fSupplier').value,
            responsible: document.getElementById('fResponsible').value,
            phone: document.getElementById('fPhone').value,
            whatsapp: document.getElementById('fWhatsapp').value,
            origin: document.getElementById('fOrigin').value,
            concentration: document.getElementById('fConcentration').value,
            price: document.getElementById('fPrice').value,
            warehouse: document.getElementById('fWarehouse').value,
            notes: document.getElementById('fNotes').value,
            askTime: document.getElementById('fAskTime').value,
            replyTime: document.getElementById('fReplyTime').value,
            createdBy: user.username
        });
        setStore(STORE_KEY, rows);
        buildPeriods(); render(); closeModal();
    });

    buildPeriods(); render();
</script>
</body>
</html>
