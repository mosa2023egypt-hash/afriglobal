<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ูุงุฆูุฉ ุงูููุงุฏ โ ุฃูุฑู ุฌููุจุงู</title>
<link rel="stylesheet" href="/new-styles.css">
</head>
<body>
<nav class="navbar" id="navbar"></nav>
<div class="container">
    <div class="card">
        <div class="card-title">๐งช ูุงุฆูุฉ ุงูููุงุฏ ุงูููุญุฏุฉ</div>

        <div class="flex-row" style="margin-bottom:14px;">
            <button class="btn btn-primary" onclick="openAddModal()">+ ุทูุจ ุฅุถุงูุฉ ูุงุฏุฉ</button>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ู</th><th>ุงุณู ุงููุงุฏุฉ</th><th>ุงูุงุณู ุจุงูุงูุฌููุฒู</th><th>ููุน ุงููุงุฏุฉ</th>
                        <th>ุงูุงุณู ุงูุชุฌุงุฑู</th><th>ูุญุฏุฉ ุงูุชุณุนูุฑ</th><th>ุงูุญุงูุฉ</th>
                        <th>ุฃูุถูู ุจูุงุณุทุฉ</th><th>ุฅุฌุฑุงุกุงุช</th>
                    </tr>
                </thead>
                <tbody id="materialsBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal ุฅุถุงูุฉ ูุงุฏุฉ -->
<div class="modal-overlay" id="modal">
    <div class="modal-box">
        <div class="modal-header">
            <h3>ุทูุจ ุฅุถุงูุฉ ูุงุฏุฉ ุฌุฏูุฏุฉ</h3>
            <button class="modal-close" onclick="closeModal()">โ</button>
        </div>
        <form id="matForm">
            <div class="form-group"><label>ุงุณู ุงููุงุฏุฉ (ุนุฑุจู)</label><input type="text" id="fName" required></div>
            <div class="form-group"><label>ุงูุงุณู ุจุงูุงูุฌููุฒู</label><input type="text" id="fNameEn"></div>
            <div class="form-group"><label>ููุน ุงููุงุฏุฉ</label><input type="text" id="fType"></div>
            <div class="form-group"><label>ุงูุงุณู ุงูุชุฌุงุฑู</label><input type="text" id="fBrandName"></div>
            <div class="form-group"><label>ูุญุฏุฉ ุงูุชุณุนูุฑ ุงูููุชุฑุญุฉ</label>
                <select id="fUnit"><option value="ton">ุทู (ุงูุชุฑุงุถู)</option><option value="kg">ูููู</option></select>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">ุฅุฑุณุงู ุงูุทูุจ</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">ุฅูุบุงุก</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal ุชุบููุฑ ูุญุฏุฉ ุงูุชุณุนูุฑ (ูููุฏูุฑูู) -->
<div class="modal-overlay" id="unitModal">
    <div class="modal-box">
        <div class="modal-header">
            <h3>ุชุบููุฑ ูุญุฏุฉ ุงูุชุณุนูุฑ</h3>
            <button class="modal-close" onclick="closeUnitModal()">โ</button>
        </div>
        <form id="unitForm">
            <input type="hidden" id="editUnitId">
            <div class="form-group"><label>ูุญุฏุฉ ุงูุชุณุนูุฑ</label>
                <select id="fUnitEdit"><option value="ton">ุทู</option><option value="kg">ูููู</option></select>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">ุญูุธ</button>
                <button type="button" class="btn btn-secondary" onclick="closeUnitModal()">ุฅูุบุงุก</button>
            </div>
        </form>
    </div>
</div>

<script src="/new-app.js"></script>
<script>
    const user = requireAuth();
    renderNavbar(user);

    const STORE_KEY = 'materials';
    const isManager = Roles.isManager(user.role);

    function getMaterials() { return getStore(STORE_KEY); }
    function saveMaterials(arr) { setStore(STORE_KEY, arr); }

    function render() {
        const materials = getMaterials();
        const tbody = document.getElementById('materialsBody');
        // Regular users see approved + their own pending; managers see all
        const visible = materials.filter(m =>
            m.status === 'approved' ||
            isManager ||
            m.createdBy === user.username
        );
        if (visible.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-muted">ูุง ุชูุฌุฏ ููุงุฏ ุจุนุฏ</td></tr>';
            return;
        }
        tbody.innerHTML = visible.map((m, i) => {
            const statusBadge = m.status === 'approved'
                ? '<span class="badge badge-approved">ูุนุชูุฏุฉ</span>'
                : m.status === 'rejected'
                    ? '<span class="badge badge-rejected">ูุฑููุถุฉ</span>'
                    : '<span class="badge badge-pending">ููุฏ ุงูุงูุชุธุงุฑ</span>';
            const unitLabel = m.unit === 'kg' ? 'ูููู' : 'ุทู';
            const canChangeUnit = isManager && m.status === 'approved';
            return `<tr>
                <td>${i+1}</td>
                <td>${m.name||''}</td>
                <td>${m.nameEn||''}</td>
                <td>${m.type||''}</td>
                <td>${m.brandName||''}</td>
                <td>${unitLabel}</td>
                <td>${statusBadge}</td>
                <td>${m.createdByName||m.createdBy||''}</td>
                <td>
                    ${canChangeUnit ? `<button class="btn btn-warning btn-sm" onclick="openUnitModal('${m.id}','${m.unit||'ton'}')">ุชุบููุฑ ุงููุญุฏุฉ</button>` : ''}
                </td>
            </tr>`;
        }).join('');
    }

    function openAddModal() {
        document.getElementById('matForm').reset();
        document.getElementById('modal').classList.add('active');
    }
    function closeModal() { document.getElementById('modal').classList.remove('active'); }

    function openUnitModal(id, unit) {
        document.getElementById('editUnitId').value = id;
        document.getElementById('fUnitEdit').value = unit;
        document.getElementById('unitModal').classList.add('active');
    }
    function closeUnitModal() { document.getElementById('unitModal').classList.remove('active'); }

    document.getElementById('matForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const materials = getMaterials();
        materials.push({
            id: uid(),
            name: document.getElementById('fName').value,
            nameEn: document.getElementById('fNameEn').value,
            type: document.getElementById('fType').value,
            brandName: document.getElementById('fBrandName').value,
            unit: document.getElementById('fUnit').value,
            status: 'pending',
            createdBy: user.username,
            createdByName: user.name,
            createdAt: new Date().toISOString()
        });
        saveMaterials(materials);
        render(); closeModal();
    });

    document.getElementById('unitForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('editUnitId').value;
        const unit = document.getElementById('fUnitEdit').value;
        const materials = getMaterials();
        const m = materials.find(x => x.id === id);
        if (m) { m.unit = unit; saveMaterials(materials); }
        render(); closeUnitModal();
    });

    render();
</script>
</body>
</html>
