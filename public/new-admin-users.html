<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† â€“ Ø£ÙØ±ÙŠ Ø¬Ù„ÙˆØ¨Ø§Ù„</title>
<link rel="stylesheet" href="/new-styles.css">
</head>
<body>
<nav class="navbar" id="navbar"></nav>
<div class="container">
    <div class="card">
        <div class="card-title">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>

        <div class="flex-row" style="margin-bottom:14px;">
            <button class="btn btn-primary" onclick="openAddModal()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
        </div>

        <div class="table-wrapper">
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>Ù…</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¯ÙˆØ±</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="usersBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… -->
<div class="modal-overlay" id="modal">
    <div class="modal-box">
        <div class="modal-header">
            <h3 id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</h3>
            <button class="modal-close" onclick="closeModal()">âœ•</button>
        </div>
        <div id="modalAlert" class="alert alert-danger hidden"></div>
        <form id="userForm">
            <input type="hidden" id="editId">
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø±Ù‚Ù…)</label>
                <input type="text" id="fUsername" required placeholder="Ù…Ø«Ø§Ù„: 1001">
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ø§Ø³Ù…</label>
                <input type="text" id="fName" required placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ">
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ø¯ÙˆØ±</label>
                <select id="fRole">
                    <option value="sales">Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                    <option value="procurement">Ù…Ø´ØªØ±ÙŠØ§Øª</option>
                    <option value="procurement_manager">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</option>
                    <option value="gm">Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…</option>
                    <option value="admin">Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</option>
                </select>
            </div>
            <div class="form-group">
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="fPassword" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØºÙŠÙŠØ±">
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </form>
    </div>
</div>

<script src="/new-app.js"></script>
<script>
    const user = requireAuth();
    if (!Roles.isAdmin(user.role) && !Roles.isGM(user.role)) {
        alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©');
        window.location.href = '/new-home.html';
    }
    renderNavbar(user);

    const STORE_KEY = 'admin_users';
    const ROLE_LABELS = { sales:'Ù…Ø¨ÙŠØ¹Ø§Øª', procurement:'Ù…Ø´ØªØ±ÙŠØ§Øª', procurement_manager:'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', gm:'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…', admin:'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…' };

    // Seed default demo users if store is empty
    function getUsers() {
        let users = getStore(STORE_KEY);
        if (users.length === 0) {
            users = [
                { id:'1', username:'1111', name:'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…',    role:'admin',               active:true },
                { id:'2', username:'2222', name:'Ù…Ø¨ÙŠØ¹Ø§Øª 1',        role:'sales',               active:true },
                { id:'3', username:'3333', name:'Ù…Ø¨ÙŠØ¹Ø§Øª 2',        role:'sales',               active:true },
                { id:'4', username:'4444', name:'Ù…Ø´ØªØ±ÙŠØ§Øª 1',       role:'procurement',         active:true },
                { id:'5', username:'5555', name:'Ù…Ø´ØªØ±ÙŠØ§Øª 2',       role:'procurement',         active:true },
                { id:'6', username:'6666', name:'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',  role:'procurement_manager', active:true },
                { id:'7', username:'7777', name:'Ù…. Ø¹Ø§Ù… 1',        role:'gm',                  active:true },
                { id:'8', username:'8888', name:'Ù…. Ø¹Ø§Ù… 2',        role:'gm',                  active:true },
                { id:'9', username:'9999', name:'Ù…. Ø¹Ø§Ù… 3',        role:'gm',                  active:true },
            ];
            setStore(STORE_KEY, users);
        }
        return users;
    }

    function saveUsers(users) { setStore(STORE_KEY, users); }

    function render() {
        const users = getUsers();
        const tbody = document.getElementById('usersBody');
        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</td></tr>';
            return;
        }
        tbody.innerHTML = users.map((u, i) => `
            <tr>
                <td>${i + 1}</td>
                <td>${u.username}</td>
                <td>${u.name}</td>
                <td>${ROLE_LABELS[u.role] || u.role}</td>
                <td><span class="badge ${u.active ? 'badge-active' : 'badge-inactive'}">${u.active ? 'Ù†Ø´Ø·' : 'Ù…Ø¹Ø·Ù‘Ù„'}</span></td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="openEditModal('${u.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="btn ${u.active ? 'btn-danger' : 'btn-success'} btn-sm" onclick="toggleActive('${u.id}')">
                        ${u.active ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„'}
                    </button>
                </td>
            </tr>`).join('');
    }

    function openAddModal() {
        document.getElementById('modalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…';
        document.getElementById('editId').value = '';
        document.getElementById('userForm').reset();
        document.getElementById('modalAlert').classList.add('hidden');
        document.getElementById('modal').classList.add('active');
    }

    function openEditModal(id) {
        const users = getUsers();
        const u = users.find(x => x.id === id);
        if (!u) return;
        document.getElementById('modalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…';
        document.getElementById('editId').value = id;
        document.getElementById('fUsername').value = u.username;
        document.getElementById('fName').value = u.name;
        document.getElementById('fRole').value = u.role;
        document.getElementById('fPassword').value = '';
        document.getElementById('modalAlert').classList.add('hidden');
        document.getElementById('modal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('modal').classList.remove('active');
    }

    function toggleActive(id) {
        const users = getUsers();
        const u = users.find(x => x.id === id);
        if (u) { u.active = !u.active; saveUsers(users); render(); }
    }

    document.getElementById('userForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const editId = document.getElementById('editId').value;
        const username = document.getElementById('fUsername').value.trim();
        const name = document.getElementById('fName').value.trim();
        const role = document.getElementById('fRole').value;
        const alertBox = document.getElementById('modalAlert');

        if (!username || !name) {
            alertBox.textContent = 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©';
            alertBox.classList.remove('hidden');
            return;
        }

        const users = getUsers();
        if (editId) {
            const u = users.find(x => x.id === editId);
            if (u) {
                if (users.find(x => x.username === username && x.id !== editId)) {
                    alertBox.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹';
                    alertBox.classList.remove('hidden');
                    return;
                }
                u.username = username; u.name = name; u.role = role;
            }
        } else {
            if (users.find(u => u.username === username)) {
                alertBox.textContent = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹';
                alertBox.classList.remove('hidden');
                return;
            }
            users.push({ id: uid(), username, name, role, active: true });
        }
        saveUsers(users);
        render();
        closeModal();
    });

    render();
</script>
</body>
</html>
