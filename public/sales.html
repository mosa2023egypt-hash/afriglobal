<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£ÙØ±ÙŠØ¬Ù„ÙˆØ¨Ø§Ù„ - Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Arial, sans-serif; background: #f4f6f9; direction: rtl; color: #333; }
        header {
            background: #1e3a5f; color: white; padding: 14px 24px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        header h1 { font-size: 20px; }
        .header-right { display: flex; align-items: center; gap: 16px; }
        .user-info { font-size: 14px; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 14px; }
        .btn-logout { background: #c0392b; color: white; }
        .btn-logout:hover { background: #e74c3c; }
        .btn-primary { background: #1e3a5f; color: white; }
        .btn-primary:hover { background: #2d5280; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #2ecc71; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #e67e22; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-whatsapp { background: #25d366; color: white; }
        .btn-whatsapp:hover { background: #128c7e; }
        .tabs { background: white; border-bottom: 2px solid #e0e0e0; padding: 0 24px; display: flex; gap: 4px; }
        .tab { padding: 14px 20px; cursor: pointer; font-size: 15px; border-bottom: 3px solid transparent; color: #666; }
        .tab.active { color: #1e3a5f; border-bottom-color: #1e3a5f; font-weight: bold; }
        .tab-content { display: none; padding: 24px; }
        .tab-content.active { display: block; }
        .card { background: white; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); margin-bottom: 20px; }
        .form-group { margin-bottom: 16px; }
        label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 6px; color: #555; }
        input, select, textarea {
            width: 100%; padding: 10px 12px; border: 1.5px solid #d0d0d0;
            border-radius: 6px; font-size: 14px; font-family: inherit; direction: rtl;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #1e3a5f; }
        textarea { resize: vertical; min-height: 70px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #1e3a5f; color: white; padding: 12px 10px; text-align: right; }
        td { padding: 11px 10px; border-bottom: 1px solid #eee; }
        tr:hover td { background: #f8f9fa; }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-draft { background: #e8e8e8; color: #555; }
        .badge-submitted { background: #fff3cd; color: #856404; }
        .badge-responded { background: #d1ecf1; color: #0c5460; }
        .badge-confirmed { background: #d4edda; color: #155724; }
        .badge-cancelled { background: #f8d7da; color: #721c24; }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; display: none; }
        .alert-error { background: #fee; color: #c00; border: 1px solid #fcc; }
        .alert-success { background: #efe; color: #060; border: 1px solid #cfc; }
        .items-section { border: 1.5px solid #d0d0d0; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .items-section h4 { margin-bottom: 12px; color: #1e3a5f; }
        .item-row { display: grid; grid-template-columns: 2fr 2fr 1fr 1fr auto; gap: 8px; align-items: end; margin-bottom: 8px; }
        .section-title { font-size: 18px; font-weight: bold; color: #1e3a5f; margin-bottom: 16px; }
        .no-data { text-align: center; color: #888; padding: 40px; }
    </style>
</head>
<body>
    <header>
        <h1>ğŸŒ Ø£ÙØ±ÙŠØ¬Ù„ÙˆØ¨Ø§Ù„ - Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h1>
        <div class="header-right">
            <span class="user-info" id="userInfo"></span>
            <a href="/approvals" style="color:white;text-decoration:none;font-size:14px;">Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª</a>
            <button class="btn btn-logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="showTab('orders')">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
        <div class="tab" onclick="showTab('new-order')">â• Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</div>
        <div class="tab" onclick="showTab('customers')">ğŸ¢ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
    </div>

    <!-- Orders Tab -->
    <div id="tab-orders" class="tab-content active">
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <div class="section-title">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
                <button class="btn btn-primary" onclick="loadOrders()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            </div>
            <div id="ordersAlert" class="alert"></div>
            <div id="ordersTable">
                <div class="no-data">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
        </div>
    </div>

    <!-- New Order Tab -->
    <div id="tab-new-order" class="tab-content">
        <div class="card">
            <div class="section-title">Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¬Ø¯ÙŠØ¯</div>
            <div id="newOrderAlert" class="alert"></div>
            <form id="newOrderForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„Ø¹Ù…ÙŠÙ„ *</label>
                        <select id="customerSelect" required>
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„</label>
                        <input type="text" id="contactPerson" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ / ÙˆØ§ØªØ³Ø§Ø¨</label>
                        <input type="tel" id="orderPhone" placeholder="01xxxxxxxxx">
                    </div>
                    <div class="form-group">
                        <label>Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…</label>
                        <input type="text" id="deliveryCity" placeholder="Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©">
                    </div>
                </div>
                <div class="form-group">
                    <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ù„Ø§ ÙŠØ±Ø§Ù‡ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª)</label>
                    <input type="text" id="warehouseText" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„ÙƒØ§Ù…Ù„">
                </div>

                <div class="items-section">
                    <h4>Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</h4>
                    <div id="itemsList"></div>
                    <button type="button" class="btn btn-primary btn-sm" onclick="addItem()">+ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆØ§ØµÙ„</label>
                        <select id="contactMethod">
                            <option value="">--</option>
                            <option value="ÙˆØ§ØªØ³Ø§Ø¨">ÙˆØ§ØªØ³Ø§Ø¨</option>
                            <option value="Ù‡Ø§ØªÙ">Ù‡Ø§ØªÙ</option>
                            <option value="Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</option>
                            <option value="Ø²ÙŠØ§Ø±Ø©">Ø²ÙŠØ§Ø±Ø©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø±Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <input type="text" id="customerReply" placeholder="Ø±Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„">
                    </div>
                </div>
                <div class="form-group">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea id="orderNotes"></textarea>
                </div>
                <div class="form-group">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©</label>
                    <textarea id="importantNotes"></textarea>
                </div>
                <div style="display:flex;gap:12px;">
                    <button type="submit" class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©</button>
                    <button type="button" class="btn btn-success" onclick="saveAndSubmit()">ğŸ“¤ Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customers Tab -->
    <div id="tab-customers" class="tab-content">
        <div class="card">
            <div class="section-title">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</div>
            <div id="customerAlert" class="alert"></div>
            <form id="customerForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ *</label>
                        <input type="text" id="custNameAr" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</label>
                        <input type="text" id="custNameEn">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="tel" id="custPhone">
                    </div>
                    <div class="form-group">
                        <label>Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„</label>
                        <input type="text" id="custContact">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                        <input type="text" id="custCity">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                        <input type="text" id="custAddress">
                    </div>
                </div>
                <div class="form-group">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea id="custNotes"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©</button>
            </form>
        </div>
        <div class="card">
            <div class="section-title">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙˆÙ†</div>
            <div id="customersTable"><div class="no-data">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
        </div>
    </div>

    <script>
        const API = '/api';
        let token = localStorage.getItem('token');
        let user = JSON.parse(localStorage.getItem('user') || '{}');
        let products = [], origins = [], customers = [];
        let submitAfterSave = false;

        if (!token) window.location.href = '/login';

        document.getElementById('userInfo').textContent = `${user.fullName || ''} (${roleLabel(user.role)})`;

        function roleLabel(r) {
            const m = {gm:'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…',sales_manager:'Ù…Ø¯ÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª',sales:'Ù…Ø¨ÙŠØ¹Ø§Øª',procurement_manager:'Ù…Ø¯ÙŠØ± Ù…Ø´ØªØ±ÙŠØ§Øª',procurement:'Ù…Ø´ØªØ±ÙŠØ§Øª'};
            return m[r] || r;
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/login';
        }

        function authHeaders() {
            return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
        }

        function showTab(name) {
            document.querySelectorAll('.tab').forEach((t, i) => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            const tabs = ['orders','new-order','customers'];
            const idx = tabs.indexOf(name);
            document.querySelectorAll('.tab')[idx].classList.add('active');
            document.getElementById(`tab-${name}`).classList.add('active');
            if (name === 'orders') loadOrders();
            if (name === 'customers') loadCustomers();
            if (name === 'new-order') loadFormData();
        }

        function showAlert(id, msg, type='error') {
            const el = document.getElementById(id);
            el.className = `alert alert-${type}`;
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function statusLabel(s) {
            const m = {
                draft:'Ù…Ø³ÙˆØ¯Ø©', submitted_to_procurement:'Ø£Ø±Ø³Ù„ Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
                procurement_responded:'Ø±Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', confirmed:'Ù…Ø¤ÙƒØ¯', cancelled:'Ù…Ù„ØºÙŠ'
            };
            return m[s] || s;
        }

        function statusClass(s) {
            const m = {draft:'badge-draft',submitted_to_procurement:'badge-submitted',
                procurement_responded:'badge-responded',confirmed:'badge-confirmed',cancelled:'badge-cancelled'};
            return m[s] || 'badge-draft';
        }

        async function loadOrders() {
            try {
                const res = await fetch(`${API}/sales-orders`, { headers: authHeaders() });
                const data = await res.json();
                if (!data.success) { showAlert('ordersAlert', data.message); return; }
                if (!data.data.length) {
                    document.getElementById('ordersTable').innerHTML = '<div class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>';
                    return;
                }
                let html = `<table><thead><tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…</th>
                    <th>Ø§Ù„Ø¨Ù†ÙˆØ¯</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr></thead><tbody>`;
                for (const o of data.data) {
                    const customer = o.customer ? o.customer.nameAr : '-';
                    const items = (o.items||[]).map(i => `${i.productNameAr||''} ${i.qtyTons||0} Ø·Ù†`).join('ØŒ ');
                    const waBtn = o.whatsappUrl && o.whatsappUrl !== '#' ?
                        `<a href="${o.whatsappUrl}" target="_blank" class="btn btn-whatsapp btn-sm">ÙˆØ§ØªØ³Ø§Ø¨</a>` : '';
                    const submitBtn = o.status === 'draft' ?
                        `<button class="btn btn-success btn-sm" onclick="submitToProcurement('${o._id}')">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>` : '';
                    html += `<tr>
                        <td><b>${o.orderNumber||'-'}</b></td>
                        <td>${customer}</td>
                        <td>${o.deliveryCity||'-'}</td>
                        <td>${items||'-'}</td>
                        <td><span class="badge ${statusClass(o.status)}">${statusLabel(o.status)}</span></td>
                        <td>${new Date(o.createdAt).toLocaleDateString('ar-EG')}</td>
                        <td style="display:flex;gap:4px;flex-wrap:wrap;">${waBtn} ${submitBtn}</td>
                    </tr>`;
                }
                html += '</tbody></table>';
                document.getElementById('ordersTable').innerHTML = html;
            } catch(err) {
                showAlert('ordersAlert', 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª');
            }
        }

        async function submitToProcurement(id) {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§ØªØŸ')) return;
            try {
                const res = await fetch(`${API}/sales-orders/${id}/submit-to-procurement`, {
                    method: 'POST', headers: authHeaders()
                });
                const data = await res.json();
                if (data.success) { showAlert('ordersAlert', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª', 'success'); loadOrders(); }
                else showAlert('ordersAlert', data.message);
            } catch(err) { showAlert('ordersAlert', 'Ø­Ø¯Ø« Ø®Ø·Ø£'); }
        }

        async function loadFormData() {
            try {
                const [pRes, oRes, cRes] = await Promise.all([
                    fetch(`${API}/approvals/products`, { headers: authHeaders() }),
                    fetch(`${API}/approvals/origins`, { headers: authHeaders() }),
                    fetch(`${API}/companies?isCustomer=true`, { headers: authHeaders() })
                ]);
                const [pData, oData, cData] = await Promise.all([pRes.json(), oRes.json(), cRes.json()]);
                products = pData.data || [];
                origins = oData.data || [];
                customers = cData.data || [];
                const sel = document.getElementById('customerSelect');
                sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ --</option>';
                customers.forEach(c => sel.innerHTML += `<option value="${c._id}">${c.nameAr}</option>`);
                if (!document.getElementById('itemsList').children.length) addItem();
            } catch(err) {}
        }

        function addItem() {
            const div = document.createElement('div');
            div.className = 'item-row';
            div.innerHTML = `
                <div>
                    <label>Ø§Ù„Ù…Ù†ØªØ¬</label>
                    <select class="item-product" onchange="updateProductName(this)">
                        <option value="">-- Ù…Ù†ØªØ¬ --</option>
                        ${products.map(p => `<option value="${p._id}" data-name="${p.nameAr}">${p.nameAr}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label>Ø§Ù„Ù…Ù†Ø´Ø£</label>
                    <select class="item-origin" onchange="updateOriginName(this)">
                        <option value="">-- Ù…Ù†Ø´Ø£ --</option>
                        ${origins.map(o => `<option value="${o._id}" data-name="${o.nameAr}">${o.nameAr}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label>Ø§Ù„ÙƒÙ…ÙŠØ© (Ø·Ù†)</label>
                    <input type="number" class="item-qty" min="0" step="0.1" placeholder="0">
                </div>
                <div>
                    <label>Ø§Ù„Ø³Ø¹Ø±/Ø·Ù†</label>
                    <input type="number" class="item-price" min="0" step="0.01" placeholder="0">
                </div>
                <div>
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-sm" style="background:#e74c3c;color:white;" onclick="this.closest('.item-row').remove()">Ø­Ø°Ù</button>
                </div>`;
            document.getElementById('itemsList').appendChild(div);
        }

        function updateProductName(sel) { /* TODO: update hidden productNameAr field on selection */ }
        function updateOriginName(sel) { /* TODO: update hidden originNameAr field on selection */ }

        function collectItems() {
            const rows = document.querySelectorAll('.item-row');
            return Array.from(rows).map(row => {
                const pSel = row.querySelector('.item-product');
                const oSel = row.querySelector('.item-origin');
                const pOpt = pSel.options[pSel.selectedIndex];
                const oOpt = oSel.options[oSel.selectedIndex];
                return {
                    product: pSel.value || undefined,
                    productNameAr: pOpt ? pOpt.dataset.name : '',
                    origin: oSel.value || undefined,
                    originNameAr: oOpt ? oOpt.dataset.name : '',
                    qtyTons: parseFloat(row.querySelector('.item-qty').value) || 0,
                    offeredPricePerTon: parseFloat(row.querySelector('.item-price').value) || 0,
                };
            }).filter(i => i.product || i.qtyTons);
        }

        async function saveAndSubmit() {
            submitAfterSave = true;
            document.getElementById('newOrderForm').dispatchEvent(new Event('submit'));
        }

        document.getElementById('newOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const customerId = document.getElementById('customerSelect').value;
            if (!customerId) { showAlert('newOrderAlert', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„'); return; }

            const payload = {
                customer: customerId,
                contactPerson: document.getElementById('contactPerson').value,
                phone: document.getElementById('orderPhone').value,
                deliveryCity: document.getElementById('deliveryCity').value,
                warehouseText: document.getElementById('warehouseText').value,
                items: collectItems(),
                contactMethod: document.getElementById('contactMethod').value,
                customerReply: document.getElementById('customerReply').value,
                notes: document.getElementById('orderNotes').value,
                importantNotes: document.getElementById('importantNotes').value,
            };

            try {
                const res = await fetch(`${API}/sales-orders`, {
                    method: 'POST', headers: authHeaders(), body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.success) {
                    if (submitAfterSave) {
                        submitAfterSave = false;
                        const id = data.data._id;
                        const res2 = await fetch(`${API}/sales-orders/${id}/submit-to-procurement`, {
                            method: 'POST', headers: authHeaders()
                        });
                        const data2 = await res2.json();
                        if (data2.success) showAlert('newOrderAlert', 'ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        else showAlert('newOrderAlert', data2.message);
                    } else {
                        showAlert('newOrderAlert', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙƒÙ…Ø³ÙˆØ¯Ø©', 'success');
                    }
                    document.getElementById('newOrderForm').reset();
                    document.getElementById('itemsList').innerHTML = '';
                } else {
                    showAlert('newOrderAlert', data.message);
                }
            } catch(err) { showAlert('newOrderAlert', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸'); }
            submitAfterSave = false;
        });

        async function loadCustomers() {
            try {
                const res = await fetch(`${API}/companies?isCustomer=true`, { headers: authHeaders() });
                const data = await res.json();
                if (!data.success) return;
                if (!data.data.length) {
                    document.getElementById('customersTable').innerHTML = '<div class="no-data">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø¹ØªÙ…Ø¯ÙˆÙ†</div>';
                    return;
                }
                let html = `<table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„</th></tr></thead><tbody>`;
                for (const c of data.data) {
                    const wa = c.phone ? `<a href="https://wa.me/${c.phone.replace(/\D/g,'')}" target="_blank" class="btn btn-whatsapp btn-sm">ÙˆØ§ØªØ³Ø§Ø¨</a>` : '';
                    html += `<tr><td>${c.nameAr}</td><td>${c.city||'-'}</td><td>${c.phone||'-'} ${wa}</td><td>${c.contactPerson||'-'}</td></tr>`;
                }
                html += '</tbody></table>';
                document.getElementById('customersTable').innerHTML = html;
            } catch(err) {}
        }

        document.getElementById('customerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                nameAr: document.getElementById('custNameAr').value,
                nameEn: document.getElementById('custNameEn').value,
                phone: document.getElementById('custPhone').value,
                contactPerson: document.getElementById('custContact').value,
                city: document.getElementById('custCity').value,
                address: document.getElementById('custAddress').value,
                notes: document.getElementById('custNotes').value,
                isCustomer: true
            };
            try {
                const res = await fetch(`${API}/companies`, {
                    method: 'POST', headers: authHeaders(), body: JSON.stringify(payload)
                });
                const data = await res.json();
                showAlert('customerAlert', data.message, data.success ? 'success' : 'error');
                if (data.success) document.getElementById('customerForm').reset();
            } catch(err) { showAlert('customerAlert', 'Ø­Ø¯Ø« Ø®Ø·Ø£'); }
        });

        // Initial load
        loadOrders();
    </script>
</body>
</html>
