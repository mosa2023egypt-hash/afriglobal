<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£ÙØ±ÙŠØ¬Ù„ÙˆØ¨Ø§Ù„ - Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Arial, sans-serif; background: #f4f6f9; direction: rtl; color: #333; }
        header {
            background: #1e3a5f; color: white; padding: 14px 24px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        header h1 { font-size: 20px; }
        .header-right { display: flex; align-items: center; gap: 16px; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 14px; }
        .btn-logout { background: #c0392b; color: white; }
        .btn-approve { background: #27ae60; color: white; }
        .btn-approve:hover { background: #2ecc71; }
        .btn-reject { background: #e74c3c; color: white; }
        .btn-reject:hover { background: #c0392b; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-refresh { background: #1e3a5f; color: white; }
        .container { max-width: 1000px; margin: 24px auto; padding: 0 24px; }
        .card { background: white; border-radius: 10px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); margin-bottom: 24px; }
        .section-title { font-size: 18px; font-weight: bold; color: #1e3a5f; margin-bottom: 16px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #1e3a5f; color: white; padding: 12px 10px; text-align: right; }
        td { padding: 11px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover td { background: #f8f9fa; }
        .no-data { text-align: center; color: #888; padding: 30px; }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; display: none; }
        .alert-error { background: #fee; color: #c00; border: 1px solid #fcc; }
        .alert-success { background: #efe; color: #060; border: 1px solid #cfc; }
        .actions { display: flex; gap: 6px; }
        .badge-count { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; }
    </style>
</head>
<body>
    <header>
        <h1>ğŸŒ Ø£ÙØ±ÙŠØ¬Ù„ÙˆØ¨Ø§Ù„ - Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª</h1>
        <div class="header-right">
            <span id="userInfo" style="font-size:14px;"></span>
            <a href="/sales" style="color:white;text-decoration:none;font-size:14px;">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</a>
            <button class="btn btn-refresh" onclick="loadAll()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn btn-logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <div class="container">
        <div id="mainAlert" class="alert"></div>

        <div class="card">
            <div class="section-title">ğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© <span id="companyCount" class="badge-count">0</span></div>
            <div id="companiesTable"><div class="no-data">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
        </div>

        <div class="card">
            <div class="section-title">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© <span id="productCount" class="badge-count">0</span></div>
            <div id="productsTable"><div class="no-data">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
        </div>

        <div class="card">
            <div class="section-title">ğŸŒ Ø§Ù„Ù…Ù†Ø§Ø´Ø¦ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© <span id="originCount" class="badge-count">0</span></div>
            <div id="originsTable"><div class="no-data">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
        </div>
    </div>

    <script>
        const API = '/api';
        let token = localStorage.getItem('token');
        let user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token) window.location.href = '/login';

        const allowed = ['gm', 'sales_manager', 'procurement_manager'];
        if (!allowed.includes(user.role)) {
            window.location.href = '/sales';
        }

        document.getElementById('userInfo').textContent = `${user.fullName || ''} (${roleLabel(user.role)})`;

        function roleLabel(r) {
            const m = {gm:'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…',sales_manager:'Ù…Ø¯ÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª',sales:'Ù…Ø¨ÙŠØ¹Ø§Øª',procurement_manager:'Ù…Ø¯ÙŠØ± Ù…Ø´ØªØ±ÙŠØ§Øª',procurement:'Ù…Ø´ØªØ±ÙŠØ§Øª'};
            return m[r] || r;
        }

        function logout() { localStorage.clear(); window.location.href = '/login'; }
        function authHeaders() { return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }; }

        function showAlert(msg, type='error') {
            const el = document.getElementById('mainAlert');
            el.className = `alert alert-${type}`;
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 4000);
        }

        async function loadAll() {
            try {
                const res = await fetch(`${API}/approvals/pending`, { headers: authHeaders() });
                const data = await res.json();
                if (!data.success) { showAlert(data.message); return; }
                renderCompanies(data.data.companies || []);
                renderProducts(data.data.products || []);
                renderOrigins(data.data.origins || []);
            } catch(err) { showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); }
        }

        function renderCompanies(items) {
            document.getElementById('companyCount').textContent = items.length;
            if (!items.length) {
                document.getElementById('companiesTable').innerHTML = '<div class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª Ù…Ø¹Ù„Ù‚Ø©</div>';
                return;
            }
            let html = `<table><thead><tr>
                <th>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ</th><th>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</th><th>Ø§Ù„Ù†ÙˆØ¹</th>
                <th>Ø£Ù†Ø´Ø£Ù‡</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th><th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr></thead><tbody>`;
            for (const c of items) {
                const type = [c.isCustomer && 'Ø¹Ù…ÙŠÙ„', c.isSupplier && 'Ù…ÙˆØ±Ø¯'].filter(Boolean).join(' / ') || '-';
                const creator = c.createdBy ? c.createdBy.fullName : '-';
                const date = new Date(c.createdAt).toLocaleDateString('ar-EG');
                html += `<tr>
                    <td><b>${c.nameAr}</b></td>
                    <td>${c.nameEn||'-'}</td>
                    <td>${type}</td>
                    <td>${creator}</td>
                    <td>${date}</td>
                    <td>${c.city||'-'}</td>
                    <td><div class="actions">
                        <button class="btn btn-approve btn-sm" onclick="approve('companies','${c._id}')">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
                        <button class="btn btn-reject btn-sm" onclick="reject('companies','${c._id}')">âŒ Ø±ÙØ¶</button>
                    </div></td>
                </tr>`;
            }
            html += '</tbody></table>';
            document.getElementById('companiesTable').innerHTML = html;
        }

        function renderProducts(items) {
            document.getElementById('productCount').textContent = items.length;
            if (!items.length) {
                document.getElementById('productsTable').innerHTML = '<div class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</div>';
                return;
            }
            let html = `<table><thead><tr>
                <th>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ</th><th>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</th><th>Ø§Ù„ÙˆØµÙ</th>
                <th>Ø£Ù†Ø´Ø£Ù‡</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr></thead><tbody>`;
            for (const p of items) {
                const creator = p.createdBy ? p.createdBy.fullName : '-';
                const date = new Date(p.createdAt).toLocaleDateString('ar-EG');
                html += `<tr>
                    <td><b>${p.nameAr}</b></td>
                    <td>${p.nameEn||'-'}</td>
                    <td>${p.description||'-'}</td>
                    <td>${creator}</td>
                    <td>${date}</td>
                    <td><div class="actions">
                        <button class="btn btn-approve btn-sm" onclick="approve('products','${p._id}')">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
                        <button class="btn btn-reject btn-sm" onclick="reject('products','${p._id}')">âŒ Ø±ÙØ¶</button>
                    </div></td>
                </tr>`;
            }
            html += '</tbody></table>';
            document.getElementById('productsTable').innerHTML = html;
        }

        function renderOrigins(items) {
            document.getElementById('originCount').textContent = items.length;
            if (!items.length) {
                document.getElementById('originsTable').innerHTML = '<div class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø´Ø¦ Ù…Ø¹Ù„Ù‚Ø©</div>';
                return;
            }
            let html = `<table><thead><tr>
                <th>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ</th><th>Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</th>
                <th>Ø£Ù†Ø´Ø£Ù‡</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr></thead><tbody>`;
            for (const o of items) {
                const creator = o.createdBy ? o.createdBy.fullName : '-';
                const date = new Date(o.createdAt).toLocaleDateString('ar-EG');
                html += `<tr>
                    <td><b>${o.nameAr}</b></td>
                    <td>${o.nameEn||'-'}</td>
                    <td>${creator}</td>
                    <td>${date}</td>
                    <td><div class="actions">
                        <button class="btn btn-approve btn-sm" onclick="approve('origins','${o._id}')">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
                        <button class="btn btn-reject btn-sm" onclick="reject('origins','${o._id}')">âŒ Ø±ÙØ¶</button>
                    </div></td>
                </tr>`;
            }
            html += '</tbody></table>';
            document.getElementById('originsTable').innerHTML = html;
        }

        async function approve(type, id) {
            await doAction(type, id, 'approve');
        }
        async function reject(type, id) {
            await doAction(type, id, 'reject');
        }

        async function doAction(type, id, action) {
            try {
                const res = await fetch(`${API}/approvals/${type}/${id}`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ action })
                });
                const data = await res.json();
                showAlert(data.message, data.success ? 'success' : 'error');
                if (data.success) loadAll();
            } catch(err) { showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£'); }
        }

        loadAll();
    </script>
</body>
</html>
